import type { NextPage } from 'next'
import Head from 'next/head'
import Link from 'next/link'
import Image from 'next/image'
import styles from '../../../styles/Home.module.css'
import DashboardNav from '../../../components/DashboardNav'
import { useState, useEffect } from 'react'
import { IFlagSet } from '../../../interfaces'
import { startOfWeek, lastDayOfWeek, isAfter, isBefore, parseISO } from 'date-fns'

const FlagsHome: NextPage = () => {
  const [recentFlags, setRecentFlags] = useState<IFlagSet[] | []>([]);
  const [thisWeeksFlags, setThisWeeksFlags] = useState<IFlagSet[] | undefined>(undefined);
  const workDays = ['Monday', 'Wednesday', 'Thursday', 'Friday']

  useEffect(() => {
    fetch("/api/flags/flagsets")
    .then((res) => res.json())
    .then((json) => {
      console.log(json);
      const date = new Date();
      const firstDay = startOfWeek(date);
      const lastDay = lastDayOfWeek(date);
      const thisWeek = json.flagsets.filter((flag: IFlagSet) => {
        if (isAfter(parseISO(flag.date), firstDay) && isBefore(parseISO(flag.date), lastDay)) {
          return flag;
        }
      })
      setThisWeeksFlags(thisWeek);
      setRecentFlags(json.flagsets);
    })
  }, [])

  return (
    <div>
      <Head>
        <title>Flag Dashboard</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <header>
        <nav className={`${styles.primary_nav}`}>
          <Link href="/teachers/flags/#"><a>Profile</a></Link>
          <Link href="/"><a>Log Out</a></Link>
        </nav>
      </header>
      <main className={`${styles.flex} ${styles.dashboard}`}>
        <DashboardNav></DashboardNav>
        <section className={`${styles.dashboard_content}`}>
          <h1>Welcome Back, Teacher Mark</h1>
          {/* <FlagCalendar></FlagCalendar>    */}
          <article>
            <div className={`${styles.card}`}>
              <div className={`${styles.grid} ${styles.flag_calendar_grid}`}>
                {workDays.map((day) => (
                  <div key={day}>
                    <p>{day}</p>
                    <ul>
                      {thisWeeksFlags?.map((flag) => {
                        if (flag.dayOfWeek === day) {
                          return (
                            <li key={flag.id}>
                              <Link href="./flags/play">
                                <a>{flag.title.slice(0,8)}</a>
                              </Link>
                            </li>
                          )
                        }
                      })}
                    </ul>
                  </div>
                ))}
              </div>
            </div>
          </article>       
          <div className={`${styles.flex} ${styles.flex_between} ${styles.flex_grow} ${styles.flex_gap}`}>
            {/* <FlagList></FlagList> */}
            <article className={`${styles.card}`}>
              <h2>Recent Flags</h2>
              <ul>
                {recentFlags?.map((flag: IFlagSet) => (
                  <li key={`flag-${flag.id}`} className={`${styles.flex} ${styles.flex_between}`}>
                    {flag.title}
                    <div className={`${styles.flex} ${styles.flex_gap}`}>
                      <Link href="./flags/play"><a>Play</a></Link>
                      <Link href={`./flags/edit/${flag.id}`}><a>Edit</a></Link>
                    </div> 
                  </li>
                ))}
              </ul>
            </article>
            <article className={`${styles.card}`}>
              <div className={`${styles.dashboard_image_container}`}>
                <Image 
                  className={styles.stacked_img}
                  src="/images/flags_ui_screenshot.jpg"
                  layout='fill'
                  objectFit='cover'
                  alt="An image of a flagboard"
                  // width={100} 
                  // height={100}
                />
              </div>
                <h2>
                  <Link href="flags/create"><a>Create</a></Link>
                </h2>
            </article>
            <article className={`${styles.card}`}>
              <h2>
                <Link href="#"><a>All Teacher&apos;s Flags</a></Link>
              </h2>
            </article>
          </div>
        </section>
      </main>
    </div>
  )
}

export default FlagsHome
